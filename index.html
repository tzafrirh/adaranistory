<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex,nofollow">
    <meta name="googlebot" content="noindex,nofollow">
    <title>הסיפור של עדה ורני</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://i.postimg.cc/nrg3GqJ3/base.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://i.postimg.cc/nrg3GqJ3/base.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://i.postimg.cc/nrg3GqJ3/base.png">
    <link rel="shortcut icon" href="https://i.postimg.cc/nrg3GqJ3/base.png">
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts for elegant Hebrew text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Dancing+Script:wght@700&family=Playpen+Sans+Hebrew:wght@700&display=swap" rel="stylesheet">
    
    <!-- Preload critical audio files -->
    <link rel="preload" href="https://files.catbox.moe/9546ir.mp3" type="audio/mpeg">
    <link rel="preload" href="https://files.catbox.moe/bt2wil.mp3" type="audio/mpeg">
    <link rel="preload" href="https://files.catbox.moe/77r59z.mp3" type="audio/mpeg">
    <link rel="preload" href="https://files.catbox.moe/rx0836.mp3" type="audio/mpeg">
    <link rel="preload" href="https://files.catbox.moe/5c0fpb.mp3" type="audio/mpeg">
    <link rel="preload" href="https://files.catbox.moe/3jbzlc.mp3" type="audio/mpeg">
    <link rel="preload" href="https://files.catbox.moe/lhbk5p.mp3" type="audio/mpeg">
    <link rel="preload" href="https://files.catbox.moe/0xk7f6.mp3" type="audio/mpeg">
    <link rel="preload" href="https://files.catbox.moe/3qehbo.mp3" type="audio/mpeg">
    <link rel="preload" href="https://files.catbox.moe/2rvixg.mp3" type="audio/mpeg">
    
    <!-- Preload critical images -->
    <link rel="preconnect" href="https://i.postimg.cc/">
    <link rel="preload" href="https://i.postimg.cc/nrg3GqJ3/base.png" as="image" type="image/png">
    <link rel="preload" href="https://i.postimg.cc/26Hc3PXR/scene1.png" as="image" type="image/png">
    <link rel="preload" href="https://i.postimg.cc/gjnMhNfw/scene2.png" as="image" type="image/png">
    <link rel="preload" href="https://i.postimg.cc/W3pYN28w/scene3.png" as="image" type="image/png">
    <link rel="preload" href="https://i.postimg.cc/15WKTxkq/scene4-new.png" as="image" type="image/png">
    <link rel="preload" href="https://i.postimg.cc/HxqmGwXQ/scene5.png" as="image" type="image/png">
    <link rel="preload" href="https://i.postimg.cc/CL23cf7T/scene6.png" as="image" type="image/png">
    <link rel="preload" href="https://i.postimg.cc/tRBQVcVg/scene7.png" as="image" type="image/png">
    <link rel="preload" href="https://i.postimg.cc/tJSKQ1H6/scene8_new.png" as="image" type="image/png">
    
    <style>
        /* CSS Variables */
        :root {
            --font-scale: 1;
        }
        
        /* Applying the M PLUS Rounded 1c font to the whole page */
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            overflow: hidden; /* Prevent scrolling the main page */
        }

        /* The book container holds all the pages */
        .book {
            width: 100%;
            height: 100dvh;
            position: relative;
            perspective: 2500px; 
        }

        /* Each scene is a page */
        .page {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: #fff; 
            transform-origin: right center; 
            transition: transform 1s ease-in-out;
            backface-visibility: hidden; /* Hides the back of the element during rotation */
            display: flex;
            flex-direction: column;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-style: solid;
            border-color: #f5eeda;
            border-width: 3vh 5vw;
            box-shadow: inset 0 0 0 1px #d1c7b8; /* This creates the thin inner line */
        }
        
        @media (orientation: portrait) {
            .page {
                border-width: 5vh 3vw;
            }
        }
        
        .page.flipped {
            transform: rotateY(180deg);
        }

        /* Slick Pagination Styling */
        .nav-arrow {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.3);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            line-height: 1;
            cursor: pointer;
            z-index: 50;
            transition: all 0.3s ease;
            user-select: none;
        }

        .nav-arrow:hover:not(:disabled) {
            background-color: rgba(0, 0, 0, 0.6);
            transform: translateY(-50%) scale(1.1);
        }

        .nav-arrow:disabled {
            opacity: 0.2;
            cursor: not-allowed;
        }

        #next-page-arrow {
            left: 20px;
        }

        #prev-page-arrow {
            right: 20px;
        }

        #page-indicator {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.4);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 50;
            transition: opacity 0.3s ease;
        }
        
        #countdown-timer {
            position: fixed;
            top: 15px;
            left: 15px;
            width: 48px;
            height: 48px;
            background-color: rgba(55, 65, 81, 0.3);
            color: white;
            border-radius: 50%;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 50;
            transition: all 0.3s ease;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        
        #countdown-timer.active {
            display: flex;
        }
        
        #countdown-timer:hover {
            background-color: rgba(55, 65, 81, 0.5);
            transform: scale(1.05);
        }
        
        /* Styling for the text overlay */
        .text-overlay {
            margin-top: auto; /* Pushes the container to the bottom */
            width: 100%;
            padding: 4rem 2rem 2rem 2rem; /* More padding at the top for the gradient */
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0));
            color: white;
            text-align: center;
        }

        .text-overlay p {
            font-size: calc(1.75rem * var(--font-scale, 1));
            line-height: 1.75;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }
        
        .text-overlay h1 {
            font-size: calc(2.75rem * var(--font-scale, 1));
            text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }
        
        @media (min-width: 768px) {
            .text-overlay p {
                font-size: calc(2.25rem * var(--font-scale, 1));
            }
            .text-overlay h1 {
                font-size: calc(4.75rem * var(--font-scale, 1));
            }
        }

        /* Typewriter effect styles */
        .story-text::after {
            content: '|';
            font-weight: 200;
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            from, to { color: transparent }
            50% { color: white; }
        }
        
        .story-text.finished-typing::after {
            content: '';
            animation: none;
        }
        
        /* Styles for hiding UI during autoplay */
        .ui-element {
            transition: opacity 0.4s ease-in-out;
        }

        body.autoplay-active .ui-element {
            opacity: 0;
            pointer-events: none;
        }

        body.autoplay-active:hover .ui-element {
            opacity: 1;
            pointer-events: auto;
        }
        
        body.autoplay-active .nav-arrow {
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* Greeting card styles for the last page */
        .greeting-card-page {
            background-color: #fdfaf3; /* Creamy white */
            border: none;
            box-shadow: none;
            padding: 0;
            color: #4B5563; /* text-gray-600 */
        }

        .greeting-card-content {
            border: 1px solid #dcd1c0;
            box-shadow: inset 0 0 0 4px #f5eeda;
            margin: 2rem;
            padding: 2rem;
            height: calc(100% - 4rem);
            width: calc(100% - 4rem);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .greeting-card-content h2 {
            font-family: 'Dancing Script', cursive;
            color: #1F2937; /* text-gray-800 */
            font-size: calc(3.75rem * var(--font-scale, 1));
        }

        .greeting-card-content p {
            font-size: calc(1.5rem * var(--font-scale, 1));
        }
        
        @media (min-width: 768px) {
             .greeting-card-content h2 {
                font-size: calc(6rem * var(--font-scale, 1));
             }
             .greeting-card-content p {
                font-size: calc(2rem * var(--font-scale, 1));
             }
        }
        
        #front-cover-content h2 {
            font-size: calc(4.5rem * var(--font-scale, 1));
        }
        
        @media (min-width: 768px) {
            #front-cover-content h2 {
                font-size: calc(7rem * var(--font-scale, 1));
            }
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="book">
        <!-- Front Page -->
        <div class="page greeting-card-page">
            <div id="front-cover-content" class="greeting-card-content">
                <h2 class="font-bold" style="font-family: 'Playpen Sans Hebrew', cursive;">שעת סיפור</h2>
            </div>
        </div>

        <!-- Page 2: Header Section -->
        <div class="page bg-[url('https://i.postimg.cc/nrg3GqJ3/base.png')]">
            <div class="text-overlay">
                <h1 class="font-bold">משימה: 7-7-0-7-5</h1>
                <p class="mt-3">התיק הסודי של עדה ורני</p>
                <p class="mt-6 text-gray-300 animate-pulse">הסיפור עומד להתחיל...</p>
            </div>
        </div>

        <!-- Page 3: Scene 1 -->
        <div class="page bg-[url('https://i.postimg.cc/26Hc3PXR/scene1.png')]">
            <div class="text-overlay">
                <p class="story-text">במשך שנים, שניים מהסוכנים המבריקים ביותר של האקדמיה פעלו באותו המטה - האוניברסיטה העברית. סוכנת אחת, עדה, מומחית למודיעין חקלאי וגמישות אנושית. הסוכן השני, רני, אגדה בתחום הגיאוגרפיה, ההיסטוריה, וניתוח שטח. אך דרכיהם מעולם לא הצטלבו, עד לפני שבע שנים, בפגישת ריגול חשאית. המשימה הראשונה שלהם: האם שני הסוכנים האגדיים, אך השונים כל כך, יוכלו להסכים על מה להזמין?</p>
            </div>
            <audio id="audio-scene-1" src="https://files.catbox.moe/9546ir.mp3" preload="auto"></audio>
        </div>

        <!-- Page 4: Scene 2 -->
        <div class="page bg-[url('https://i.postimg.cc/gjnMhNfw/scene2.png')]">
            <div class="text-overlay">
                <p class="story-text">משימתם הגדולה ביותר לקחה אותם לפריז למבצע ריגול בן חודשיים. רני, הדובר צרפתית שוטף, ניווט את השטח כמו המומחה שהוא. משימתה האישית של עדה: לשרוד בארץ הבגטים והחמאה, תוך הקפדה על פרוטוקול תזונתי מחמיר.</p>
            </div>
            <audio id="audio-scene-2" src="https://files.catbox.moe/bt2wil.mp3" preload="auto"></audio>
        </div>

        <!-- Page 5: Scene 3 -->
        <div class="page bg-[url('https://i.postimg.cc/W3pYN28w/scene3.png')]">
            <div class="text-overlay">
                <p class="story-text">בחזרה במטה בתל אביב, התנהלו ויכוחים אסטרטגיים יומיומיים. "פסגת המומחים", בה האגרונומית והגיאוגרף התווכחו על נושאים ברומו של עולם: מהו המסלול הנכון לטיול הבוקר? הדרך היעילה ביותר גיאוגרפית, או זו עם האנרגיה הטובה ביותר?</p>
            </div>
            <audio id="audio-scene-3" src="https://files.catbox.moe/77r59z.mp3" preload="auto"></audio>
        </div>

        <!-- Page 6: Scene 4 (Dead Sea) -->
        <div class="page bg-[url('https://i.postimg.cc/15WKTxkq/scene4-new.png')]">
            <div class="text-overlay">
                <p class="story-text">משימתם הקבועה הבאה לקחה אותם לנקודה הנמוכה ביותר בעולם, למבצע חשאי במיוחד: "מבצע ים המלח". הסוכן רני נשלח למשימת הסתננות וספיגת אנרגיה סולארית, הידועה גם בשם "בטן-גב". במקביל, הסוכנת עדה הקימה עמדת תצפית מוצלת, שם תרגלה תרגילי גמישות מורכבים תוך שהיא נמנעת באלגנטיות ממגע ישיר עם האויב... השמש הקופחת.</p>
            </div>
            <audio id="audio-scene-4" src="https://files.catbox.moe/rx0836.mp3" preload="auto"></audio>
        </div>

        <!-- Page 7: Scene 5 (was 4) -->
        <div class="page bg-[url('https://i.postimg.cc/HxqmGwXQ/scene5.png')]">
            <div class="text-overlay">
                <p class="story-text">משימתם המורכבת ביותר: ניהול שתי אימפריות. עדה, אחראית על "הזרוע האמריקאית" ו"הסניף המקומי". רני, מנהל את הדיוויזיה הוותיקה והמפוארת שלו - הלא היא "זרוע אהרונסון". יחד, הם מהווים את הגשר שמחבר בין שתי השושלות.</p>
            </div>
            <audio id="audio-scene-5" src="https://files.catbox.moe/5c0fpb.mp3" preload="auto"></audio>
        </div>

        <!-- Page 8: Scene 6 (was 5) -->
        <div class="page bg-[url('https://i.postimg.cc/CL23cf7T/scene6.png')]">
            <div class="text-overlay">
                <p class="story-text">במקביל, הסוכן רני ממשיך במשימת חייו: "מבצע: הספר". אבל לסוכנת עדה, "קצינת המוטיבציה הראשית", יש טקטיקה חדשה. במקום לזרז אותו, היא מנסה לפתות אותו עם תוכניות למבצע הבא שלהם... טיול חדש ליעד מרגש.</p>
            </div>
            <audio id="audio-scene-6" src="https://files.catbox.moe/3jbzlc.mp3" preload="auto"></audio>
        </div>

        <!-- Page 9: Scene 7 (was 6) -->
        <div class="page bg-[url('https://i.postimg.cc/tRBQVcVg/scene7.png')]">
            <div class="text-overlay">
                <p class="story-text">אבל כל המשימות האלה היו רק חימום למבצע השיא. הגעה ליעדים הנועזים ביותר: יום הולדת 70 ויום הולדת 75! עדה השיגה דרגת "שלוות יוגה וחוכמת אדמה". רני השיג דרגת "גאונות פרופסורית וקסם של סבא".</p>
            </div>
            <audio id="audio-scene-7" src="https://files.catbox.moe/lhbk5p.mp3" preload="auto"></audio>
        </div>

        <!-- Page 10: Scene 8 (was 7) -->
        <div class="page bg-[url('https://i.postimg.cc/tJSKQ1H6/scene8_new.png')]">
            <div class="text-overlay">
                <p class="story-text">אז לעדה ולרני, השותפים לדרך, המשימה הושלמה בהצלחה. בשבע השנים האלה, הראיתם לכולנו שההרפתקאות הגדולות באמת לא תלויות בגיל, שסיפור חדש יכול להתחיל כשלא מצפים לו, ושגם שני סוכנים שונים כל כך יכולים לבנות יחד חיים מדהימים - חיים שמלאים בצחוק, בחוכמה, ובוויכוח היומי החשוב על מה אוכלים לארוחת צהריים. אנחנו אוהבים אתכם ומאחלים לכם עוד שנים רבות של מבצעים משותפים. יום הולדת שמח!</p>
            </div>
            <audio id="audio-scene-8" src="https://files.catbox.moe/0xk7f6.mp3" preload="auto"></audio>
        </div>
        
        <!-- Page 11: Dedication -->
        <div class="page greeting-card-page" id="dedication-page">
            <div class="greeting-card-content">
                <h2 class="font-bold">מזל טוב</h2>
                <p class="mt-4">לרגל 7 שנים של הרפתקאות משותפות וימי הולדת 70 ו-75</p>
                <svg class="w-24 h-8 my-4 md:my-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 101 12" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6h9.375c1.428 0 2.58-1.152 2.58-2.58V3.375c0-1.428 1.152-2.58 2.58-2.58h21.31c1.428 0 2.58 1.152 2.58 2.58v.045c0 1.428 1.152 2.58 2.58 2.58h14.55c1.428 0 2.58-1.152 2.58-2.58v-.045c0-1.428 1.152-2.58 2.58-2.58h21.31c1.428 0 2.58 1.152 2.58 2.58v.045c0 1.428 1.152 2.58 2.58 2.58H98.25" />
                </svg>
                <p class="text-2xl md:text-3xl" style="font-family: 'Dancing Script', cursive;">אוהבים,</p>
                <p class="mt-2">שחר, צפריר וטל, גלעד, אמה וניב, והדר ואיציק</p>
            </div>
            <audio id="audio-scene-9" src="https://files.catbox.moe/3qehbo.mp3" preload="auto"></audio>
        </div>
    </div>

    <!-- Slick Pagination Elements -->
    <button id="next-page-arrow" class="nav-arrow" title="העמוד הבא">&#x276F;</button>
    <button id="prev-page-arrow" class="nav-arrow" title="העמוד הקודם">&#x276E;</button>
    <div id="page-indicator" class="ui-element"></div>
    
    <!-- Countdown Timer -->
    <div id="countdown-timer" class="ui-element">5</div>

    <!-- Floating Menu Button and Dropdown -->
    <div class="fixed top-4 right-4 z-[100] ui-element">
        <button id="menu-button" class="w-12 h-12 bg-gray-800 bg-opacity-30 rounded-full flex items-center justify-center text-white text-3xl hover:bg-opacity-50 transition backdrop-blur-sm">
            &#9881;
        </button>
        <div id="menu-dropdown" class="hidden absolute top-14 right-0 bg-white rounded-lg shadow-xl p-1 sm:p-2 w-48 sm:w-56 text-right z-10">
            <div class="p-1 sm:p-2">
                <div class="flex items-center justify-between">
                    <label for="animation-toggle" class="text-xs sm:text-sm text-gray-700 select-none cursor-pointer">אנימציית טקסט</label>
                    <input type="checkbox" id="animation-toggle" class="h-5 w-5 rounded text-blue-500 focus:ring-0">
                </div>
            </div>
            <div class="p-1 sm:p-2">
                <div class="flex items-center justify-between">
                    <label for="autoplay-toggle" class="text-xs sm:text-sm text-gray-700 select-none cursor-pointer">ניגון אוטומטי</label>
                    <input type="checkbox" id="autoplay-toggle" class="h-5 w-5 rounded text-blue-500 focus:ring-0">
                </div>
            </div>
            <div class="p-1 sm:p-2">
                <div class="flex items-center justify-between">
                    <label for="narration-toggle" class="text-xs sm:text-sm text-gray-700 select-none cursor-pointer">קריינות</label>
                    <input type="checkbox" id="narration-toggle" class="h-5 w-5 rounded text-blue-500 focus:ring-0">
                </div>
            </div>
            <div class="p-1 sm:p-2">
                <div class="flex items-center justify-between">
                    <label for="music-toggle" class="text-xs sm:text-sm text-gray-700 select-none cursor-pointer">מוזיקת רקע</label>
                    <input type="checkbox" id="music-toggle" class="h-5 w-5 rounded text-blue-500 focus:ring-0">
                </div>
            </div>
            <div class="p-1 sm:p-2">
                <div class="flex items-center justify-between">
                    <label for="timer-toggle" class="text-xs sm:text-sm select-none cursor-pointer" id="timer-label">טיימר ספירה לאחור</label>
                    <input type="checkbox" id="timer-toggle" class="h-5 w-5 rounded text-blue-500 focus:ring-0" disabled>
                </div>
            </div>
            <div class="p-1 sm:p-2 border-t border-gray-200 mt-1 sm:mt-2 pt-1 sm:pt-2">
                <label for="volume-slider" class="text-xs sm:text-sm text-gray-700 select-none">עוצמת מוזיקה</label>
                <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
            </div>
            <div class="p-1 sm:p-2 border-t border-gray-200 mt-1 sm:mt-2 pt-1 sm:pt-2">
                <label for="font-size-slider" class="text-xs sm:text-sm text-gray-700 select-none">גודל גופן</label>
                <input type="range" id="font-size-slider" min="0.7" max="1.3" step="0.05" value="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
            </div>
            <div class="border-t border-gray-200 mt-1 sm:mt-2 pt-1 sm:pt-2">
                <button id="restart-button" class="w-full text-right text-gray-700 hover:bg-gray-100 p-2 rounded flex items-center">
                    <span class="text-base sm:text-xl ml-2">&#x21BA;</span> <!-- Restart Icon -->
                    <span class="text-xs sm:text-sm">התחלה מחדש</span>
                </button>
            </div>
            <div class="border-t border-gray-200 mt-1 sm:mt-2 pt-1 sm:pt-2">
                <button id="fullscreen-button" class="w-full text-right text-gray-700 hover:bg-gray-100 p-2 rounded flex items-center">
                    <span id="enter-fullscreen-icon" class="text-base sm:text-xl ml-2">&#x26F6;</span> <!-- Fullscreen Icon -->
                    <span id="exit-fullscreen-icon" class="text-base sm:text-xl ml-2 hidden">&#x2716;</span> <!-- Exit Icon -->
                    <span id="fullscreen-text" class="text-xs sm:text-sm">מסך מלא</span>
                </button>
            </div>
        </div>
        <div class="absolute top-16 right-0 mt-2 space-y-2">
            <button id="play-pause-button" class="hidden w-12 h-12 bg-gray-800 bg-opacity-30 rounded-full flex items-center justify-center text-white text-2xl hover:bg-opacity-50 transition backdrop-blur-sm">
                <span id="play-icon">&#9654;</span>
                <span id="pause-icon" class="hidden">&#9208;</span>
            </button>
            <button id="mute-button" class="hidden w-12 h-12 bg-gray-800 bg-opacity-30 rounded-full flex items-center justify-center text-white text-2xl hover:bg-opacity-50 transition backdrop-blur-sm">
                <span id="unmute-icon">&#128266;</span>
                <span id="mute-icon" class="hidden">&#128263;</span>
            </button>
        </div>
    </div>

    <!-- Background Music Audio Element -->
    <audio id="background-music" src="https://files.catbox.moe/2rvixg.mp3" loop></audio>

    <script>
        
        // --- Optimized State Management ---
        class StoryBookApp {
            constructor() {
                // DOM element cache
                this.elements = this.cacheElements();
                
                // Application state
                this.state = {
                    currentPage: 0,
                    totalPages: this.elements.pages.length,
                    animationEnabled: false,
                    autoPlayEnabled: false,
                    narrationEnabled: false,
                    musicEnabled: false,
                    isPaused: false,
                    isMuted: false,
                    currentAudio: null,
                    originalTexts: new Map(),
                    textFinished: false,
                    audioFinished: false,
                    timerVisible: false
                };
                
                // Timeout references for cleanup
                this.timeouts = {
                    typewriter: null,
                    autoPlay: null,
                    pageTransition: null,
                    countdown: null
                };
                
                // Countdown state
                this.countdown = {
                    active: false,
                    remainingTime: 0,
                    interval: null
                };
                
                // Constants
                this.constants = {
                    TYPEWRITER_DELAY: 85,
                    AUTO_PLAY_DELAY: 4000,
                    HEADER_PAGE_DELAY: 10000,
                    DEFAULT_PAGE_DELAY: 2500,
                    DEBOUNCE_DELAY: 250,
                    PAGE_TRANSITION_DELAY: 2500
                };
                
                // Bound methods for event listeners
                this.boundMethods = {
                    handleKeydown: this.debounce(this.handleKeydown.bind(this), this.constants.DEBOUNCE_DELAY),
                    handleDocumentClick: this.handleDocumentClick.bind(this),
                    handleFullscreenChange: this.handleFullscreenChange.bind(this),
                    handleVolumeChange: this.debounce(this.handleVolumeChange.bind(this), 100),
                    handleFontSizeChange: this.debounce(this.handleFontSizeChange.bind(this), 100)
                };
            }
            
            // Cache all DOM elements once
            cacheElements() {
                const elements = {};
                
                // Navigation elements
                elements.prevBtn = document.getElementById('prev-page-arrow');
                elements.nextBtn = document.getElementById('next-page-arrow');
                elements.pageIndicator = document.getElementById('page-indicator');
                elements.countdownTimer = document.getElementById('countdown-timer');
                elements.pages = document.querySelectorAll('.page');
                
                // Menu elements
                elements.menuButton = document.getElementById('menu-button');
                elements.menuDropdown = document.getElementById('menu-dropdown');
                
                // Control toggles
                elements.animationToggle = document.getElementById('animation-toggle');
                elements.autoPlayToggle = document.getElementById('autoplay-toggle');
                elements.narrationToggle = document.getElementById('narration-toggle');
                elements.musicToggle = document.getElementById('music-toggle');
                elements.timerToggle = document.getElementById('timer-toggle');
                elements.timerLabel = document.getElementById('timer-label');
                
                // Media controls
                elements.playPauseBtn = document.getElementById('play-pause-button');
                elements.playIcon = document.getElementById('play-icon');
                elements.pauseIcon = document.getElementById('pause-icon');
                elements.muteBtn = document.getElementById('mute-button');
                elements.unmuteIcon = document.getElementById('unmute-icon');
                elements.muteIcon = document.getElementById('mute-icon');
                
                // Other controls
                elements.restartBtn = document.getElementById('restart-button');
                elements.fontSizeSlider = document.getElementById('font-size-slider');
                elements.volumeSlider = document.getElementById('volume-slider');
                
                // Fullscreen elements
                elements.fullscreenBtn = document.getElementById('fullscreen-button');
                elements.fullscreenText = document.getElementById('fullscreen-text');
                elements.enterFullscreenIcon = document.getElementById('enter-fullscreen-icon');
                elements.exitFullscreenIcon = document.getElementById('exit-fullscreen-icon');
                
                // Audio elements
                elements.backgroundMusic = document.getElementById('background-music');
                elements.storyTextElements = document.querySelectorAll('.story-text');
                
                return elements;
            }
            
            // Utility: Debounce function for performance optimization
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            // Utility: Error handling wrapper
            safeExecute(func, fallback = () => {}) {
                try {
                    return func();
                } catch (error) {
                    console.error('StoryBook Error:', error);
                    return fallback();
                }
            }
            
            // Utility: Clean up timeouts
            clearAllTimeouts(includeCountdown = true) {
                if (this.timeouts.typewriter) {
                    clearTimeout(this.timeouts.typewriter);
                    this.timeouts.typewriter = null;
                }
                if (this.timeouts.autoPlay) {
                    clearTimeout(this.timeouts.autoPlay);
                    this.timeouts.autoPlay = null;
                }
                if (this.timeouts.pageTransition) {
                    clearTimeout(this.timeouts.pageTransition);
                    this.timeouts.pageTransition = null;
                }
                
                // Only clear countdown if explicitly requested
                if (includeCountdown) {
                    if (this.timeouts.countdown) {
                        clearTimeout(this.timeouts.countdown);
                        this.timeouts.countdown = null;
                    }
                    this.stopCountdown();
                }
            }

            // --- Countdown Timer Methods ---
            startCountdown(durationMs) {
                if (!this.state.autoPlayEnabled || this.state.isPaused) {
                    return;
                }
                
                this.stopCountdown();
                this.countdown.active = true;
                this.countdown.remainingTime = Math.ceil(durationMs / 1000);
                
                // Show timer only if visibility setting is on
                if (this.state.timerVisible) {
                    this.elements.countdownTimer.classList.add('active');
                }
                this.updateCountdownDisplay();
                
                // Update every second
                this.countdown.interval = setInterval(() => {
                    this.countdown.remainingTime--;
                    this.updateCountdownDisplay();
                    
                    if (this.countdown.remainingTime <= 0) {
                        this.stopCountdown();
                    }
                }, 1000);
            }
            
            stopCountdown() {
                if (this.countdown.interval) {
                    clearInterval(this.countdown.interval);
                    this.countdown.interval = null;
                }
                this.countdown.active = false;
                this.countdown.remainingTime = 0;
                this.elements.countdownTimer.classList.remove('active');
            }
            
            updateCountdownDisplay() {
                this.elements.countdownTimer.textContent = this.countdown.remainingTime;
            }
            
            updateTimerToggleState() {
                const isEnabled = this.state.autoPlayEnabled;
                this.elements.timerToggle.disabled = !isEnabled;
                
                // Update label styling based on enabled state
                if (isEnabled) {
                    this.elements.timerLabel.classList.remove('text-gray-400');
                    this.elements.timerLabel.classList.add('text-gray-700');
                    this.elements.timerLabel.style.cursor = 'pointer';
                } else {
                    this.elements.timerLabel.classList.remove('text-gray-700');
                    this.elements.timerLabel.classList.add('text-gray-400');
                    this.elements.timerLabel.style.cursor = 'default';
                    
                    // If auto-play is disabled, hide timer and uncheck
                    this.state.timerVisible = false;
                    this.elements.timerToggle.checked = false;
                    this.stopCountdown();
                }
            }

            // --- Initialization ---
            initialize() {
                this.safeExecute(() => {
                    // Store original text content
                    this.elements.storyTextElements.forEach((el, index) => {
                        this.state.originalTexts.set(index + 2, el.innerHTML);
                        el.innerHTML = this.state.originalTexts.get(index + 2);
                        el.classList.add('finished-typing');
                    });
                    
                    // Set up page z-index for stacking
                    this.elements.pages.forEach((page, index) => {
                        page.style.zIndex = this.state.totalPages - index;
                    });
                    
                    // Initialize UI
                    this.updatePagination();
                    this.setAutoPlayState(false);
                    this.setMusicState(false);
                    this.updateTimerToggleState(); // Set initial timer toggle state
                    this.attachEventListeners();
                    
                    // Add keyboard navigation hints
                    this.addAccessibilitySupport();
                });
            }

            // Add accessibility support
            addAccessibilitySupport() {
                // Add ARIA labels
                this.elements.prevBtn.setAttribute('aria-label', 'Previous page');
                this.elements.nextBtn.setAttribute('aria-label', 'Next page');
                this.elements.playPauseBtn.setAttribute('aria-label', 'Play/Pause');
                this.elements.muteBtn.setAttribute('aria-label', 'Mute/Unmute');
                
                // Add role attributes
                this.elements.pageIndicator.setAttribute('role', 'status');
                this.elements.pageIndicator.setAttribute('aria-live', 'polite');
                
                // Focus management
                this.elements.pages.forEach(page => {
                    page.setAttribute('tabindex', '-1');
                });
            }
            
            // --- Optimized Audio Control ---
            stopAllAudio() {
                return this.safeExecute(() => {
                    const audioElements = document.querySelectorAll('audio:not(#background-music)');
                    
                    audioElements.forEach(audio => {
                        audio.pause();
                        audio.currentTime = 0;
                    });

                    this.state.currentAudio = null;
                });
            }

            playCurrentPageAudio() {
                return this.safeExecute(() => {
                    this.stopAllAudio();
                    
                    if (!this.state.narrationEnabled || this.state.isPaused) {
                        // If narration is disabled, mark audio as "finished" immediately
                        this.state.audioFinished = true;
                        this.checkAndStartAutoPlay();
                        return;
                    }
                    
                    const audio = this.elements.pages[this.state.currentPage]?.querySelector('audio');
                    
                    if (!audio) {
                        // No audio element, mark as "finished"
                        this.state.audioFinished = true;
                        this.checkAndStartAutoPlay();
                        return;
                    }
                    
                    // Use the audio element directly without cloning
                    this.state.currentAudio = audio;
                    this.state.currentAudio.muted = this.state.isMuted;
                    
                    // Define the event handler as a named function so we can remove it later
                    const handleAudioEnded = () => {
                        this.state.audioFinished = true;
                        this.checkAndStartAutoPlay();
                    };
                    
                    // Remove any existing ended event listener (in case it exists)
                    // The { once: true } option automatically removes the listener after firing
                    // but we're being extra careful here
                    this.state.currentAudio.removeEventListener('ended', handleAudioEnded);
                    
                    const playPromise = this.state.currentAudio.play();

                    if (playPromise) {
                        playPromise
                            .then(() => {
                                // Audio started successfully - add event listener with once: true
                                // This automatically removes the listener after it fires once
                                this.state.currentAudio.addEventListener('ended', handleAudioEnded, { once: true });
                            })
                            .catch(error => {
                                console.warn("Audio autoplay blocked or failed:", error);
                                // If audio fails to play, mark as finished to avoid blocking
                                this.state.audioFinished = true;
                                this.checkAndStartAutoPlay();
                            });
                    }
                });
            }

            // --- Optimized Core Logic ---
            typeWriter(element, text, i = 0) {
                if (this.state.isPaused || !this.state.animationEnabled) {
                    return;
                }
                
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    this.timeouts.typewriter = setTimeout(() => {
                        this.typeWriter(element, text, i + 1);
                    }, this.constants.TYPEWRITER_DELAY);
                } else {
                    element.classList.add('finished-typing');
                    this.state.textFinished = true;
                    this.checkAndStartAutoPlay();
                }
            }

            handlePageContent() {
                return this.safeExecute(() => {
                    // Clear timeouts but keep countdown running (will be replaced by startPageCountdown)
                    this.clearAllTimeouts(false);
                    
                    // Reset completion flags for new page
                    this.state.textFinished = false;
                    this.state.audioFinished = false;
                    
                    // Delay countdown start to allow audio metadata to load
                    // Start countdown after a brief delay to ensure audio metadata is available
                    if (this.state.autoPlayEnabled) {
                        setTimeout(() => this.startPageCountdown(), 500);
                    }
                    
                    const textElement = this.elements.pages[this.state.currentPage]?.querySelector('.story-text');
                    
                    if (textElement) {
                        textElement.innerHTML = '';
                        textElement.classList.remove('finished-typing');
                        const fullText = this.state.originalTexts.get(this.state.currentPage);

                        if (this.state.animationEnabled && !this.state.isPaused && fullText) {
                            // Only delay if autoplay is enabled (to allow page transition to complete)
                            if (this.state.autoPlayEnabled) {
                                this.timeouts.pageTransition = setTimeout(() => {
                                    this.playCurrentPageAudio();
                                    this.typeWriter(textElement, fullText);
                                }, this.constants.PAGE_TRANSITION_DELAY);
                            } else {
                                // No delay when manually controlling pages
                                this.playCurrentPageAudio();
                                this.typeWriter(textElement, fullText);
                            }
                        } else if (fullText) {
                            // No delay for instant text - show immediately
                            this.playCurrentPageAudio();
                            textElement.innerHTML = fullText;
                            textElement.classList.add('finished-typing');
                            this.state.textFinished = true;
                            this.checkAndStartAutoPlay();
                        }
                    } else {
                        // No text element - apply same delay logic for audio
                        if (this.state.autoPlayEnabled) {
                            // Check if this is the last page - no delay needed
                            if (this.state.currentPage === this.state.totalPages - 1) {
                                // Last page - start audio immediately
                                this.playCurrentPageAudio();
                                this.state.textFinished = true;
                                this.checkAndStartAutoPlay();
                            } else {
                                // Other pages - delay audio start to allow page transition to complete
                                this.timeouts.pageTransition = setTimeout(() => {
                                    this.playCurrentPageAudio();
                                    // No text, so mark as finished immediately
                                    this.state.textFinished = true;
                                    this.checkAndStartAutoPlay();
                                }, this.constants.PAGE_TRANSITION_DELAY);
                            }
                        } else {
                            // No delay when manually controlling pages
                            this.playCurrentPageAudio();
                        }
                    }
                });
            }

            turnPage(direction) {
                return this.safeExecute(() => {
                    if (direction === 'next' && this.state.currentPage < this.state.totalPages - 1) {
                        this.elements.pages[this.state.currentPage].classList.add('flipped');
                        this.state.currentPage++;
                    } else if (direction === 'prev' && this.state.currentPage > 0) {
                        this.state.currentPage--;
                        this.elements.pages[this.state.currentPage].classList.remove('flipped');
                    }
                    
                    this.handlePageContent();
                    this.updatePagination();
                    
                    // Focus management for accessibility
                    this.elements.pages[this.state.currentPage].focus();
                });
            }

            // --- Optimized Autoplay Logic ---
            setAutoPlayState(isPlaying) {
                return this.safeExecute(() => {
                    this.state.autoPlayEnabled = isPlaying;
                    this.elements.autoPlayToggle.checked = isPlaying;
                    this.elements.playPauseBtn.classList.toggle('hidden', !isPlaying);
                    
                    // Update timer toggle availability
                    this.updateTimerToggleState();
            
                    if (isPlaying) {
                        document.body.classList.add('autoplay-active');
                        this.state.isPaused = false;
                        this.updatePlayPauseIcon();
                        this.handlePageContent();
                    } else {
                        document.body.classList.remove('autoplay-active');
                        this.state.isPaused = false;
                        this.updatePlayPauseIcon();
                        this.clearAllTimeouts();
                        this.stopCountdown();
                        
                        if (this.state.currentAudio) {
                            this.state.currentAudio.pause();
                        }
                    }
                });
            }
            
            autoTurnPage() {
                if (this.state.autoPlayEnabled && !this.state.isPaused && 
                    this.state.currentPage < this.state.totalPages - 1) {
                    this.turnPage('next');
                }
            }

            checkAndStartAutoPlay() {
                // Only start auto-play timer when both text and audio are finished (if applicable)
                if (!this.state.autoPlayEnabled || this.state.isPaused) {
                    return;
                }

                const textElement = this.elements.pages[this.state.currentPage]?.querySelector('.story-text');
                const hasText = textElement && this.state.originalTexts.get(this.state.currentPage);
                const hasAudio = this.state.narrationEnabled;

                // Determine what needs to finish based on current settings
                const textShouldFinish = hasText;
                const audioShouldFinish = hasAudio;

                // Check if everything that should finish has finished
                const textReady = !textShouldFinish || this.state.textFinished;
                const audioReady = !audioShouldFinish || this.state.audioFinished;

                if (textReady && audioReady) {
                    // Both are ready, start the delay before auto-page-turn
                    // Don't clear countdown - it should continue running
                    let delay;
                    if (this.state.currentPage === 1) {
                        delay = this.constants.HEADER_PAGE_DELAY;
                    } else if (!this.state.animationEnabled && !this.state.narrationEnabled) {
                        // Special case: when both text animation and narration are off, use longer delay
                        delay = this.constants.HEADER_PAGE_DELAY; // 10 seconds
                    } else {
                        delay = this.constants.AUTO_PLAY_DELAY; // 4 seconds
                    }
                    this.startAutoPlayTimer(delay);
                }
            }

            calculateContentDuration() {
                const textElement = this.elements.pages[this.state.currentPage]?.querySelector('.story-text');
                const fullText = this.state.originalTexts.get(this.state.currentPage);
                const audio = this.elements.pages[this.state.currentPage]?.querySelector('audio');
                
                let textDuration = 0;
                let audioDuration = 0;
                
                // Calculate text animation duration
                if (this.state.animationEnabled && textElement && fullText) {
                    // Strip HTML tags to get actual character count
                    const textContent = fullText.replace(/<[^>]*>/g, '');
                    textDuration = (textContent.length * this.constants.TYPEWRITER_DELAY) + this.constants.PAGE_TRANSITION_DELAY;
                }
                
                // Calculate audio duration
                if (this.state.narrationEnabled && audio) {
                    if (audio.duration && !isNaN(audio.duration)) {
                        audioDuration = this.constants.PAGE_TRANSITION_DELAY + (audio.duration * 1000);
                    } else {
                        // Fallback: estimate based on average reading speed if audio duration unavailable
                        const textContent = fullText ? fullText.replace(/<[^>]*>/g, '') : '';
                        const estimatedAudioDuration = Math.max(3000, textContent.length * 100); // ~100ms per character
                        audioDuration = this.constants.PAGE_TRANSITION_DELAY + estimatedAudioDuration;
                    }
                }
                
                // Return the longer of the two (since they run in parallel)
                const contentDuration = Math.max(textDuration, audioDuration);
                
                // Debug logging
                console.log(`Page ${this.state.currentPage}: text=${textDuration}ms, audio=${audioDuration}ms, content=${contentDuration}ms`);
                
                return contentDuration;
            }

            startPageCountdown() {
                // Start countdown immediately when page turns (if auto-play is enabled)
                if (!this.state.autoPlayEnabled || this.state.isPaused) {
                    return;
                }
                
                // Don't show countdown on the last page
                if (this.state.currentPage === this.state.totalPages - 1) {
                    return;
                }
                
                // Calculate actual content duration + final delay
                const contentDuration = this.calculateContentDuration();
                let finalDelay;
                if (this.state.currentPage === 1) {
                    finalDelay = this.constants.HEADER_PAGE_DELAY;
                } else if (!this.state.animationEnabled && !this.state.narrationEnabled) {
                    // Special case: when both text animation and narration are off, use longer delay
                    finalDelay = this.constants.HEADER_PAGE_DELAY; // 10 seconds
                } else {
                    finalDelay = this.constants.AUTO_PLAY_DELAY; // 4 seconds
                }
                const totalDuration = contentDuration + finalDelay;
                
                // Debug logging for countdown
                console.log(`Page ${this.state.currentPage} countdown: content=${contentDuration}ms + delay=${finalDelay}ms = total=${totalDuration}ms (${Math.ceil(totalDuration/1000)}s)`);
                
                // Show countdown with real duration
                this.startCountdown(totalDuration);
            }

            startAutoPlayTimer(delay = this.constants.AUTO_PLAY_DELAY) {
                if (!this.state.autoPlayEnabled || this.state.isPaused) {
                    return;
                }
                
                // Don't set a timer if we're already on the last page
                if (this.state.currentPage === this.state.totalPages - 1) {
                    return;
                }
                
                // Clear only the autoPlay timeout, keep countdown running
                if (this.timeouts.autoPlay) {
                    clearTimeout(this.timeouts.autoPlay);
                    this.timeouts.autoPlay = null;
                }
                
                this.timeouts.autoPlay = setTimeout(() => this.autoTurnPage(), delay);
            }

            interruptAutoPlay(turnOff = true) {
                if (this.state.autoPlayEnabled) {
                    if (turnOff) {
                        this.setAutoPlayState(false);
                    } else {
                        this.state.isPaused = true;
                        this.updatePlayPauseIcon();
                        this.clearAllTimeouts();
                        this.stopCountdown();
                        if (this.state.currentAudio) {
                            this.state.currentAudio.pause();
                        }
                    }
                }
            }

            restartStory() {
                return this.safeExecute(() => {
                    const wasAutoplaying = this.state.autoPlayEnabled;
                    this.interruptAutoPlay();
                    this.stopAllAudio();
                    
                    // Reset page states
                    this.elements.pages.forEach(page => page.classList.remove('flipped'));

                    this.state.currentPage = 0;
                    this.elements.storyTextElements.forEach(el => {
                        el.innerHTML = '';
                        el.classList.remove('finished-typing');
                    });
                    
                    this.updatePagination();
                    
                    if (wasAutoplaying) {
                        this.setAutoPlayState(true);
                    } else {
                        this.handlePageContent();
                    }
                    
                    this.elements.menuDropdown.classList.add('hidden');
                });
            }

            // --- Optimized Fullscreen Logic ---
            toggleFullscreen() {
                return this.safeExecute(() => {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen()
                            .catch(err => {
                                console.warn(`Fullscreen failed: ${err.message}`);
                                // User-friendly notification instead of alert
                                this.showNotification('Fullscreen mode not available');
                            });
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        }
                    }
                });
            }
            
            // --- UI Update Methods ---
            updatePagination() {
                return this.safeExecute(() => {
                    const pageNames = {
                        0: "פתיחה",
                        1: "שער", 
                        [this.state.totalPages - 1]: "הקדשה"
                    };
                    
                    this.elements.pageIndicator.textContent = pageNames[this.state.currentPage] || `${this.state.currentPage - 1} / ${this.state.totalPages - 3}`;
                    this.elements.prevBtn.disabled = (this.state.currentPage === 0);
                    this.elements.nextBtn.disabled = (this.state.currentPage === this.state.totalPages - 1);
                });
            }
            
            updatePlayPauseIcon() {
                this.elements.playIcon.classList.toggle('hidden', !this.state.isPaused);
                this.elements.pauseIcon.classList.toggle('hidden', this.state.isPaused);
            }

            updateMuteIcon() { 
                this.elements.unmuteIcon.classList.toggle('hidden', this.state.isMuted);
                this.elements.muteIcon.classList.toggle('hidden', !this.state.isMuted);
                if (this.state.currentAudio) {
                    this.state.currentAudio.muted = this.state.isMuted;
                }
            }
            
            updateFullscreenButton() {
                if (document.fullscreenElement) {
                    this.elements.fullscreenText.textContent = "צא ממסך מלא";
                    this.elements.enterFullscreenIcon.classList.add('hidden');
                    this.elements.exitFullscreenIcon.classList.remove('hidden');
                } else {
                    this.elements.fullscreenText.textContent = "מסך מלא";
                    this.elements.enterFullscreenIcon.classList.remove('hidden');
                    this.elements.exitFullscreenIcon.classList.add('hidden');
                }
            }
            
            // Utility: Show user notification
            showNotification(message, duration = 3000) {
                const notification = document.createElement('div');
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                    background: rgba(0,0,0,0.8); color: white; padding: 10px 20px;
                    border-radius: 5px; z-index: 1000; font-size: 14px;
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), duration);
            }

            // --- Optimized Music Control ---
            setMusicState(isPlaying) {
                return this.safeExecute(() => {
                    this.state.musicEnabled = isPlaying;
                    this.elements.musicToggle.checked = isPlaying;
                    
                    if (isPlaying) {
                        this.elements.backgroundMusic.play()
                            .catch(e => console.warn("Music autoplay blocked:", e));
                    } else {
                        this.elements.backgroundMusic.pause();
                    }
                });
            }
            
            // --- Optimized Event Handlers ---
            handleKeydown(e) {
                switch(e.key) {
                    case 'ArrowLeft':
                        if (!this.elements.nextBtn.disabled) {
                            this.interruptAutoPlay();
                            this.turnPage('next');
                        }
                        break;
                    case 'ArrowRight':
                        if (!this.elements.prevBtn.disabled) {
                            this.interruptAutoPlay();
                            this.turnPage('prev');
                        }
                        break;
                    case ' ':
                    case 'Spacebar':
                        e.preventDefault();
                        if (this.state.autoPlayEnabled) {
                            this.togglePlayPause();
                        }
                        break;
                    case 'Escape':
                        if (document.fullscreenElement) {
                            this.toggleFullscreen();
                        }
                        this.elements.menuDropdown.classList.add('hidden');
                        break;
                }
            }
            
            handleDocumentClick(e) {
                if (!this.elements.menuDropdown.contains(e.target) && 
                    !this.elements.menuButton.contains(e.target)) {
                    this.elements.menuDropdown.classList.add('hidden');
                }
            }
            
            handleFullscreenChange() {
                this.updateFullscreenButton();
            }
            
            handleVolumeChange(e) {
                this.elements.backgroundMusic.volume = e.target.value;
            }
            
            handleFontSizeChange(e) {
                document.documentElement.style.setProperty('--font-scale', e.target.value);
            }
            
            togglePlayPause() {
                this.state.isPaused = !this.state.isPaused;
                this.updatePlayPauseIcon();
                
                if (this.state.isPaused) {
                    this.clearAllTimeouts();
                    this.stopCountdown();
                    if (this.state.currentAudio) this.state.currentAudio.pause();
                    if (this.state.musicEnabled) this.elements.backgroundMusic.pause();
                } else {
                    if (this.state.currentAudio) {
                        this.state.currentAudio.play().catch(e => console.warn("Audio resume failed:", e));
                    }
                    if (this.state.musicEnabled) {
                        this.elements.backgroundMusic.play().catch(e => console.warn("Music resume failed:", e));
                    }
                    this.handlePageContent();
                }
            }
            
            // --- Event Listener Attachment ---
            attachEventListeners() {
                // Navigation listeners
                this.elements.nextBtn.addEventListener('click', () => {
                    this.interruptAutoPlay();
                    this.turnPage('next');
                });
                
                this.elements.prevBtn.addEventListener('click', () => {
                    this.interruptAutoPlay();
                    this.turnPage('prev');
                });
                
                // Keyboard listeners
                document.addEventListener('keydown', this.boundMethods.handleKeydown);
                
                // Menu listeners
                this.elements.menuButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.elements.menuDropdown.classList.toggle('hidden');
                });
                
                document.addEventListener('click', this.boundMethods.handleDocumentClick);
                
                // Control listeners
                this.elements.animationToggle.addEventListener('change', () => {
                    this.state.animationEnabled = this.elements.animationToggle.checked;
                    this.handlePageContent();
                });
                
                this.elements.autoPlayToggle.addEventListener('change', () => {
                    this.setAutoPlayState(this.elements.autoPlayToggle.checked);
                });
                
                this.elements.narrationToggle.addEventListener('change', () => {
                    this.state.narrationEnabled = this.elements.narrationToggle.checked;
                    this.elements.muteBtn.classList.toggle('hidden', !this.state.narrationEnabled);
                    
                    if (this.state.narrationEnabled) {
                        this.playCurrentPageAudio();
                    } else {
                        this.stopAllAudio();
                    }
                });
                
                this.elements.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
                
                this.elements.muteBtn.addEventListener('click', () => {
                    this.state.isMuted = !this.state.isMuted;
                    this.updateMuteIcon();
                });
                
                this.elements.restartBtn.addEventListener('click', () => this.restartStory());
                
                this.elements.fontSizeSlider.addEventListener('input', this.boundMethods.handleFontSizeChange);
                
                this.elements.fullscreenBtn.addEventListener('click', () => this.toggleFullscreen());
                
                document.addEventListener('fullscreenchange', this.boundMethods.handleFullscreenChange);
                
                // Music listeners
                this.elements.musicToggle.addEventListener('change', () => {
                    this.setMusicState(this.elements.musicToggle.checked);
                });
                
                this.elements.timerToggle.addEventListener('change', () => {
                    this.state.timerVisible = this.elements.timerToggle.checked;
                    if (!this.state.timerVisible) {
                        // Just hide the timer, don't stop the countdown interval
                        this.elements.countdownTimer.classList.remove('active');
                    } else if (this.state.autoPlayEnabled && this.countdown.active) {
                        // Show existing countdown if it's already running
                        this.elements.countdownTimer.classList.add('active');
                    }
                });
                
                this.elements.volumeSlider.addEventListener('input', this.boundMethods.handleVolumeChange);
            }
            
            // Cleanup method for memory management
            destroy() {
                this.clearAllTimeouts();
                this.stopCountdown();
                if (this.state.currentAudio) {
                    this.state.currentAudio.pause();
                }
                this.elements.backgroundMusic.pause();
                
                // Remove event listeners
                document.removeEventListener('keydown', this.boundMethods.handleKeydown);
                document.removeEventListener('click', this.boundMethods.handleDocumentClick);
                document.removeEventListener('fullscreenchange', this.boundMethods.handleFullscreenChange);
            }
        }
        
        // --- Application Initialization ---
        const storyBook = new StoryBookApp();
        storyBook.initialize();
    </script>

</body>
</html>
